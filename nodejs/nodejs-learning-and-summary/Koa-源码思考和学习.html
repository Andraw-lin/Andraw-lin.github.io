<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Koa æºç æ€è€ƒå’Œå­¦ä¹ </title>
    <meta name="generator" content="VuePress 1.6.0">
    
    <meta name="description" content="å¥½å¥½å­¦ä¹ ï¼Œå¤©å¤©å‘ä¸ŠğŸ’ª">
    <link rel="preload" href="/assets/css/0.styles.a748b10c.css" as="style"><link rel="preload" href="/assets/js/app.62b9dc26.js" as="script"><link rel="preload" href="/assets/js/2.1177bb59.js" as="script"><link rel="preload" href="/assets/js/80.dcf79b90.js" as="script"><link rel="prefetch" href="/assets/js/10.a3eb2dd7.js"><link rel="prefetch" href="/assets/js/100.a0587a90.js"><link rel="prefetch" href="/assets/js/101.bc61ee8e.js"><link rel="prefetch" href="/assets/js/102.6c9a3815.js"><link rel="prefetch" href="/assets/js/103.b27b845c.js"><link rel="prefetch" href="/assets/js/104.66db0c7a.js"><link rel="prefetch" href="/assets/js/105.900b60f5.js"><link rel="prefetch" href="/assets/js/106.9ccab627.js"><link rel="prefetch" href="/assets/js/107.29f88d5b.js"><link rel="prefetch" href="/assets/js/108.7981e08e.js"><link rel="prefetch" href="/assets/js/109.b33024ae.js"><link rel="prefetch" href="/assets/js/11.8bb20b07.js"><link rel="prefetch" href="/assets/js/110.3b0e64b4.js"><link rel="prefetch" href="/assets/js/111.8906ec31.js"><link rel="prefetch" href="/assets/js/112.f2c7dd3a.js"><link rel="prefetch" href="/assets/js/113.4126790c.js"><link rel="prefetch" href="/assets/js/114.f584a619.js"><link rel="prefetch" href="/assets/js/115.aa3ce001.js"><link rel="prefetch" href="/assets/js/116.9fc7b46a.js"><link rel="prefetch" href="/assets/js/117.02392f6b.js"><link rel="prefetch" href="/assets/js/118.be950d41.js"><link rel="prefetch" href="/assets/js/119.12f1724b.js"><link rel="prefetch" href="/assets/js/12.495dead6.js"><link rel="prefetch" href="/assets/js/120.8ec47d18.js"><link rel="prefetch" href="/assets/js/121.59dab4d9.js"><link rel="prefetch" href="/assets/js/122.ba73929a.js"><link rel="prefetch" href="/assets/js/123.f1f96cdb.js"><link rel="prefetch" href="/assets/js/124.e9ee3ab6.js"><link rel="prefetch" href="/assets/js/13.125ff0e3.js"><link rel="prefetch" href="/assets/js/14.638fd70a.js"><link rel="prefetch" href="/assets/js/15.c6414c00.js"><link rel="prefetch" href="/assets/js/16.e5534201.js"><link rel="prefetch" href="/assets/js/17.52920d84.js"><link rel="prefetch" href="/assets/js/18.e348c11a.js"><link rel="prefetch" href="/assets/js/19.3b4ed4a3.js"><link rel="prefetch" href="/assets/js/20.91aa8274.js"><link rel="prefetch" href="/assets/js/21.ef7544cb.js"><link rel="prefetch" href="/assets/js/22.c79ecf29.js"><link rel="prefetch" href="/assets/js/23.d74b8bc0.js"><link rel="prefetch" href="/assets/js/24.e1b7042f.js"><link rel="prefetch" href="/assets/js/25.ee0d54de.js"><link rel="prefetch" href="/assets/js/26.5ce41a17.js"><link rel="prefetch" href="/assets/js/27.506fca63.js"><link rel="prefetch" href="/assets/js/28.9e16b1bc.js"><link rel="prefetch" href="/assets/js/29.5f3fc6bd.js"><link rel="prefetch" href="/assets/js/3.56a9ad25.js"><link rel="prefetch" href="/assets/js/30.0b8b1b94.js"><link rel="prefetch" href="/assets/js/31.f972863c.js"><link rel="prefetch" href="/assets/js/32.58c91d73.js"><link rel="prefetch" href="/assets/js/33.40ec3e53.js"><link rel="prefetch" href="/assets/js/34.e948a627.js"><link rel="prefetch" href="/assets/js/35.89965b4f.js"><link rel="prefetch" href="/assets/js/36.773346af.js"><link rel="prefetch" href="/assets/js/37.8265a7ea.js"><link rel="prefetch" href="/assets/js/38.6814416d.js"><link rel="prefetch" href="/assets/js/39.2b4fe455.js"><link rel="prefetch" href="/assets/js/4.b41e69dd.js"><link rel="prefetch" href="/assets/js/40.fda79697.js"><link rel="prefetch" href="/assets/js/41.868f73f6.js"><link rel="prefetch" href="/assets/js/42.252a1ee9.js"><link rel="prefetch" href="/assets/js/43.4776516f.js"><link rel="prefetch" href="/assets/js/44.46eab99f.js"><link rel="prefetch" href="/assets/js/45.30564ad8.js"><link rel="prefetch" href="/assets/js/46.f0ad47dd.js"><link rel="prefetch" href="/assets/js/47.1b687bd7.js"><link rel="prefetch" href="/assets/js/48.16105aba.js"><link rel="prefetch" href="/assets/js/49.4c2c2c5e.js"><link rel="prefetch" href="/assets/js/5.5bc5eaa4.js"><link rel="prefetch" href="/assets/js/50.76421ba3.js"><link rel="prefetch" href="/assets/js/51.2f7f6f8b.js"><link rel="prefetch" href="/assets/js/52.4d4ee877.js"><link rel="prefetch" href="/assets/js/53.3c3a975c.js"><link rel="prefetch" href="/assets/js/54.4c9798c7.js"><link rel="prefetch" href="/assets/js/55.46fb092c.js"><link rel="prefetch" href="/assets/js/56.cc9a5bea.js"><link rel="prefetch" href="/assets/js/57.2dfac948.js"><link rel="prefetch" href="/assets/js/58.a1f91605.js"><link rel="prefetch" href="/assets/js/59.dbfdef0b.js"><link rel="prefetch" href="/assets/js/6.e416f727.js"><link rel="prefetch" href="/assets/js/60.a91a795c.js"><link rel="prefetch" href="/assets/js/61.bc1f5260.js"><link rel="prefetch" href="/assets/js/62.e2ccf952.js"><link rel="prefetch" href="/assets/js/63.2bd0c4cc.js"><link rel="prefetch" href="/assets/js/64.62c29a64.js"><link rel="prefetch" href="/assets/js/65.c110ae95.js"><link rel="prefetch" href="/assets/js/66.8e1a481f.js"><link rel="prefetch" href="/assets/js/67.30980d54.js"><link rel="prefetch" href="/assets/js/68.ba51dd58.js"><link rel="prefetch" href="/assets/js/69.336ac10e.js"><link rel="prefetch" href="/assets/js/7.671bf4d5.js"><link rel="prefetch" href="/assets/js/70.1a2832a2.js"><link rel="prefetch" href="/assets/js/71.5225ac1d.js"><link rel="prefetch" href="/assets/js/72.dd642248.js"><link rel="prefetch" href="/assets/js/73.84d46fc4.js"><link rel="prefetch" href="/assets/js/74.e1e7d470.js"><link rel="prefetch" href="/assets/js/75.2d7155c4.js"><link rel="prefetch" href="/assets/js/76.1b9e602d.js"><link rel="prefetch" href="/assets/js/77.cb915066.js"><link rel="prefetch" href="/assets/js/78.9bfd5a4d.js"><link rel="prefetch" href="/assets/js/79.cea94be8.js"><link rel="prefetch" href="/assets/js/8.c1053140.js"><link rel="prefetch" href="/assets/js/81.4bcdd175.js"><link rel="prefetch" href="/assets/js/82.a39c4dd4.js"><link rel="prefetch" href="/assets/js/83.d020fb52.js"><link rel="prefetch" href="/assets/js/84.b656b381.js"><link rel="prefetch" href="/assets/js/85.63f2aab3.js"><link rel="prefetch" href="/assets/js/86.f207c5aa.js"><link rel="prefetch" href="/assets/js/87.4ff13574.js"><link rel="prefetch" href="/assets/js/88.90318af9.js"><link rel="prefetch" href="/assets/js/89.c738a3bb.js"><link rel="prefetch" href="/assets/js/9.25317bd4.js"><link rel="prefetch" href="/assets/js/90.5cfedce5.js"><link rel="prefetch" href="/assets/js/91.65e09223.js"><link rel="prefetch" href="/assets/js/92.af40c683.js"><link rel="prefetch" href="/assets/js/93.3e34cd57.js"><link rel="prefetch" href="/assets/js/94.24583a56.js"><link rel="prefetch" href="/assets/js/95.f3157245.js"><link rel="prefetch" href="/assets/js/96.f12c7c46.js"><link rel="prefetch" href="/assets/js/97.83aad559.js"><link rel="prefetch" href="/assets/js/98.3e876f13.js"><link rel="prefetch" href="/assets/js/99.711d526d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a748b10c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/icon.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  ä¸»é¡µ
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="æŠ€æœ¯åˆ†äº«" class="dropdown-title"><span class="title">æŠ€æœ¯åˆ†äº«</span> <span class="arrow down"></span></button> <button type="button" aria-label="æŠ€æœ¯åˆ†äº«" class="mobile-dropdown-title"><span class="title">æŠ€æœ¯åˆ†äº«</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/javascript/javascript-learning-and-summary/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/html/html-learning-and-summary/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/css/css-learning-and-summary/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/react/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/webpack/webpack-learning-and-summary/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/ts/ts-learning-and-summary/" class="nav-link">
  Typescript
</a></li><li class="dropdown-item"><!----> <a href="/nodejs/nodejs-learning-and-summary/" class="nav-link router-link-active">
  Nodejs
</a></li><li class="dropdown-item"><!----> <a href="/weex/weex-learning-and-summary/" class="nav-link">
  Weex
</a></li><li class="dropdown-item"><!----> <a href="/network/network-learning-and-summary/" class="nav-link">
  Network
</a></li><li class="dropdown-item"><!----> <a href="/datastructure/datastructure-learning-and-summary/" class="nav-link">
  æ•°æ®ç»“æ„
</a></li><li class="dropdown-item"><!----> <a href="/mixin/mixin-learning-and-summary/" class="nav-link">
  æ—¥å¸¸æ‚è®°
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Andraw-lin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  ä¸»é¡µ
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="æŠ€æœ¯åˆ†äº«" class="dropdown-title"><span class="title">æŠ€æœ¯åˆ†äº«</span> <span class="arrow down"></span></button> <button type="button" aria-label="æŠ€æœ¯åˆ†äº«" class="mobile-dropdown-title"><span class="title">æŠ€æœ¯åˆ†äº«</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/javascript/javascript-learning-and-summary/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/html/html-learning-and-summary/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/css/css-learning-and-summary/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/react/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/webpack/webpack-learning-and-summary/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/ts/ts-learning-and-summary/" class="nav-link">
  Typescript
</a></li><li class="dropdown-item"><!----> <a href="/nodejs/nodejs-learning-and-summary/" class="nav-link router-link-active">
  Nodejs
</a></li><li class="dropdown-item"><!----> <a href="/weex/weex-learning-and-summary/" class="nav-link">
  Weex
</a></li><li class="dropdown-item"><!----> <a href="/network/network-learning-and-summary/" class="nav-link">
  Network
</a></li><li class="dropdown-item"><!----> <a href="/datastructure/datastructure-learning-and-summary/" class="nav-link">
  æ•°æ®ç»“æ„
</a></li><li class="dropdown-item"><!----> <a href="/mixin/mixin-learning-and-summary/" class="nav-link">
  æ—¥å¸¸æ‚è®°
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Andraw-lin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/nodejs/nodejs-learning-and-summary" class="sidebar-heading clickable router-link-active open"><span>Nodejs å­¦ä¹ å’Œæ€»ç»“</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/nodejs/nodejs-learning-and-summary/Express-Build-Architecture-Based-On-Node-And-Mongodb.html" class="sidebar-link">åŸºäºnodejs+mongodbä½¿ç”¨expressæ­å»ºé¡¹ç›®æ¶æ„</a></li><li><a href="/nodejs/nodejs-learning-and-summary/Node-åŸºç¡€çŸ¥è¯†.html" class="sidebar-link">Nodejs çŸ¥è¯†ç‚¹æ€»ç»“</a></li><li><a href="/nodejs/nodejs-learning-and-summary/Koa-æºç æ€è€ƒå’Œå­¦ä¹ .html" class="active sidebar-link">Koa æºç æ€è€ƒå’Œå­¦ä¹ </a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nodejs/nodejs-learning-and-summary/Koa-æºç æ€è€ƒå’Œå­¦ä¹ .html#å…ˆä»-new-koa-å¼€å§‹" class="sidebar-link">å…ˆä» new Koa() å¼€å§‹</a></li><li class="sidebar-sub-header"><a href="/nodejs/nodejs-learning-and-summary/Koa-æºç æ€è€ƒå’Œå­¦ä¹ .html#ä¸­é—´ä»¶å¤„ç†å‡½æ•°çš„ç»„åˆ" class="sidebar-link">ä¸­é—´ä»¶å¤„ç†å‡½æ•°çš„ç»„åˆ</a></li><li class="sidebar-sub-header"><a href="/nodejs/nodejs-learning-and-summary/Koa-æºç æ€è€ƒå’Œå­¦ä¹ .html#ä¸Šä¸‹æ–‡-context-çš„å°è£…" class="sidebar-link">ä¸Šä¸‹æ–‡ context çš„å°è£…</a></li><li class="sidebar-sub-header"><a href="/nodejs/nodejs-learning-and-summary/Koa-æºç æ€è€ƒå’Œå­¦ä¹ .html#å¤„ç†æœåŠ¡å™¨æ‰€æ¥æ”¶çš„è¯·æ±‚" class="sidebar-link">å¤„ç†æœåŠ¡å™¨æ‰€æ¥æ”¶çš„è¯·æ±‚</a></li><li class="sidebar-sub-header"><a href="/nodejs/nodejs-learning-and-summary/Koa-æºç æ€è€ƒå’Œå­¦ä¹ .html#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="koa-æºç æ€è€ƒå’Œå­¦ä¹ "><a href="#koa-æºç æ€è€ƒå’Œå­¦ä¹ " class="header-anchor">#</a> Koa æºç æ€è€ƒå’Œå­¦ä¹ </h1> <p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒKoa å’Œ Express æ˜¯ Nodejs é‡Œå¸¸ç”¨åˆ°çš„ä¸¤ä¸ª HTTP åº“ï¼Œå¹¶ä¸”å®ƒä»¬ä¸¤ä¸ªæ˜¯ç”±åŒä¸€ä¸ªå›¢é˜Ÿè¿›è¡Œç¼–å†™ï¼Œå…¶ä¸­ Express æ²¿ç”¨çš„æ˜¯å›è°ƒå‡½æ•°æ¨¡å¼ï¼ŒKoa åˆ™è·Ÿä¸Š ECMAScript å‘å±•ï¼Œä½¿ç”¨ç”Ÿæˆå™¨æ¥ç¼–å†™ï¼Œåˆ°äº† Koa 2.0 ååˆ™ç›´æ¥ç”¨ä¸Šäº† async/awaitï¼Œå¯ä»¥è¯´ Koa æ›´åŠ ä¼˜äºæˆ‘ä»¬çš„ç¼–å†™ã€‚ğŸ¤”</p> <p>æœ€é‡è¦çš„ä¸€ç‚¹ï¼Œ<strong>Koa å’Œ Express éƒ½æ˜¯ä»¥ä¸­é—´ä»¶ä½œä¸ºæ ¸å¿ƒ</strong>ï¼Œå› æ­¤å¾ˆå¤šåŠŸèƒ½éƒ½æ˜¯ä¾èµ–ç¤¾åŒºå®ç°å’Œè¡¥å……ã€‚Koa å†…éƒ¨å®ç°å¾ˆç®€å•ï¼Œä¸»è¦åŒ…æ‹¬äº†<strong>å¯¹ Contextã€Request å’Œ Response çš„å°è£…</strong>ã€<strong>ä¸­é—´ä»¶çš„ç»„åˆ</strong>ä¸¤å¤§å—å†…å®¹ã€‚</p> <p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹çœ‹ Koa 2.0 æºç å®ç°ã€‚å½“ç„¶å¦‚æœæœ‰å…´è¶£çš„ï¼Œå¯ä»¥ç›´æ¥å»<a href="https://github.com/koajs/koa/blob/master/lib/application.js" target="_blank" rel="noopener noreferrer">Koaçš„githubç½‘å€è§‚çœ‹æºç <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚</p> <h2 id="å…ˆä»-new-koa-å¼€å§‹"><a href="#å…ˆä»-new-koa-å¼€å§‹" class="header-anchor">#</a> å…ˆä» new Koa() å¼€å§‹</h2> <p>å¦‚æœä½ ç”¨è¿‡ Koaï¼Œè‚¯å®šåœ¨ç¼–å†™å…¥å£æ–‡ä»¶æ—¶ï¼Œå¿…ä¸å¯å°‘çš„ä¸€å¥è¯å°±æ˜¯<code>const app = new Koa()</code>ï¼Œå…¶å®å°±æ˜¯åˆ›å»ºä¸€ä¸ª Koa å®ä¾‹ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒKoa æ„é€ å‡½æ•°éƒ½æœ‰å“ªäº›å†…å®¹ï¼Œä¸å¦¨å…ˆæ¥çœ‹çœ‹ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ...</span>
<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>proxy <span class="token operator">=</span> options<span class="token punctuation">.</span>proxy <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// æ˜¯å¦å…è®¸ä»£ç†</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>subdomainOffset <span class="token operator">=</span> options<span class="token punctuation">.</span>subdomainOffset <span class="token operator">||</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// ä»hostnameè§£æå­åŸŸçš„åç§»èµ·ç‚¹ï¼Œæ¯”å¦‚åœ°å€tobi.ferrets.example.comï¼Œåç§»é‡ä¸º2æ—¶åˆ™ä¸ºtobi.ferrets</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>proxyIpHeader <span class="token operator">=</span> options<span class="token punctuation">.</span>proxyIpHeader <span class="token operator">||</span> <span class="token string">'X-Forwarded-For'</span><span class="token punctuation">;</span> <span class="token comment">// ä»£ç†å¤´éƒ¨å­—æ®µ</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>maxIpsCount <span class="token operator">=</span> options<span class="token punctuation">.</span>maxIpsCount <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>env <span class="token operator">=</span> options<span class="token punctuation">.</span>env <span class="token operator">||</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">;</span> <span class="token comment">// å½“å‰è¿è¡Œç¯å¢ƒ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>keys <span class="token operator">=</span> options<span class="token punctuation">.</span>keys<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// é‡ç‚¹ï¼ï¼ï¼ç”¨äºå­˜å‚¨ä¸­é—´ä»¶çš„æ•°ç»„</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Koaå°è£…å¥½çš„ä¸Šä¸‹æ–‡</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>request <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Koaå°è£…å¥½çš„Requestå¯¹è±¡</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>response <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Koaå°è£…å¥½çš„Responseå¯¹è±¡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>util<span class="token punctuation">.</span>inspect<span class="token punctuation">.</span>custom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span>util<span class="token punctuation">.</span>inspect<span class="token punctuation">.</span>custom<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inspect<span class="token punctuation">;</span> <span class="token comment">// èµ‹äºˆKoaçš„ç™½åå•å±æ€§ï¼Œå³åˆ›å»ºå®ä¾‹åå¯è®¿é—®å±æ€§</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
</code></pre></div><p>å’‹ä¸€çœ‹ï¼Œå…¶å®åŸºæœ¬éƒ½æ˜¯ä¸€äº›ä»£ç†é…ç½®å’Œå½“å‰è¿è¡Œç¯å¢ƒè®¾ç½®ï¼Œå…¶ä¸­**<code>middleware</code>å±æ€§åˆ™æ˜¯ç”¨äºå­˜å‚¨ä¸­é—´ä»¶å¤„ç†å‡½æ•°çš„æ•°ç»„**ï¼Œå¦å¤–**<code>context</code>å±æ€§ã€<code>request</code>å±æ€§ã€<code>response</code>å±æ€§å°±æ˜¯ Koa å•ç‹¬å°è£…å¥½çš„ä¸‰ä¸ªå±æ€§**ï¼Œæ›´å¥½æ»´ç”¨äºäº¤äº’å’Œå¤„ç†ã€‚</p> <p>ç´§æ¥ç€ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹ä¸‹é¢è¿™ä¸ªç®€å•ğŸŒ°ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'haha'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>é‚£ä¹ˆ<code>app.use</code>è¿™ä¸ª API ä¸»è¦æ˜¯åšäº›ä»€ä¹ˆäº‹æƒ…å‘¢ï¼Ÿä¸å¦¨ç›´æ¥è·Ÿä½ è¯´ï¼Œå°±æ˜¯å°†ä¸­é—´ä»¶å‡½æ•°æ¨è¿›å†…éƒ¨çš„<code>middleware</code>æ•°ç»„ä¸­è¿›è¡Œä¿å­˜ç”¨çš„ã€‚å…ˆæ¥çœ‹çœ‹æºç çš„å®ç°ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * Use the given middleware `fn`.
 *
 * Old-style middleware will be converted.
 *
 * @param {Function} fn
 * @return {Application} self
 * @api public
 */</span>
<span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'middleware must be a function!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åˆ¤æ–­ä¼ å…¥çš„å‚æ•°æ˜¯å¦ä¸ºå‡½æ•°ï¼Œå¦åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isGeneratorFunction</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// åˆ¤æ–­ä¼ å…¥çš„å‚æ•°æ˜¯å¦ä¸ºç”Ÿæˆå™¨å‡½æ•°</span>
    <span class="token function">deprecate</span><span class="token punctuation">(</span><span class="token string">'Support for generators will be removed in v3. '</span> <span class="token operator">+</span>
              <span class="token string">'See the documentation for examples of how to convert old middleware '</span> <span class="token operator">+</span>
              <span class="token string">'https://github.com/koajs/koa/blob/master/docs/migration.md'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fn <span class="token operator">=</span> <span class="token function">convert</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä½¿ç”¨koa-convertç›´æ¥åŒ…è£…ç”Ÿæˆå™¨å‡½æ•°</span>
  <span class="token punctuation">}</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'use %s'</span><span class="token punctuation">,</span> fn<span class="token punctuation">.</span>_name <span class="token operator">||</span> fn<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°†ä¸­é—´ä»¶å¤„ç†å‡½æ•°ç›´æ¥æ”¾åˆ°å†…éƒ¨æ•°ç»„ä¸­è¿›è¡Œä¿å­˜</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// æœ€ç»ˆè¿”å›å½“å‰Koaå®ä¾‹</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é¦–å…ˆæ˜ç¡®ä¸€ç‚¹çš„æ˜¯ï¼Œ<code>app.use</code>è¯¥ API ä¸­ä¼ å…¥çš„å‚æ•°å¿…é¡»æ˜¯å‡½æ•°ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œ<strong>å½“ä¼ å…¥çš„å‚æ•°æ˜¯ç”Ÿæˆå™¨å‡½æ•°ï¼Œé‚£ä¹ˆå°±æ˜¯éœ€è¦ä½¿ç”¨<code>koa-convert</code>åŒ…è£…ä¸€å±‚å˜æˆ Promise ä¸­é—´ä»¶</strong>ï¼Œå…·ä½“å¯çœ‹çœ‹å…¶<a href="https://github.com/koajs/convert" target="_blank" rel="noopener noreferrer">githubåœ°å€<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œå…¶å®ä¹Ÿæ˜¯ä¸ºäº†èƒ½å¤Ÿä½¿ Koa 2.0 èƒ½å¤Ÿå‘å‰å…¼å®¹ï¼Œç”±äº Koa 1.x ç”¨çš„å°±æ˜¯ç”Ÿæˆå™¨å‡½æ•°å¤„ç†ä¸­é—´ä»¶ã€‚</p> <p>åˆ°äº†æœ€åï¼Œå°±æ˜¯ç›´æ¥å°†ä¸­é—´ä»¶å¤„ç†å‡½æ•°ä¸€ä¸€å­˜å‚¨åˆ° Koa å®ä¾‹çš„å†…éƒ¨ middleware å±æ€§ä¸­ï¼Œä¾¿äºåé¢ä½¿ç”¨ã€‚</p> <p>##app.listen() åé¢ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆ</p> <p>å¦‚æœä½ ç¼–å†™è¿‡åŸç”Ÿ Nodeï¼Œä¼°è®¡å¯¹ä¸‹æ–¹è¿™å¨ä»£ç å¹¶ä¸é™Œç”Ÿã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> host <span class="token operator">=</span> <span class="token string">'localhost'</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">3000</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span>
  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/plain'</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'haha...'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> host<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The server is started...'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>ä¸Šè¿°å°±æ˜¯ç›´æ¥åˆ›å»ºä¸€ä¸ª http æœåŠ¡å™¨ï¼Œæ¥ç€è®¾ç½®ç›¸åº”çš„è¿”å›çŠ¶æ€ä»¥åŠå†…å®¹ã€‚</p> <p>ä½†æ˜¯ï¼Œä» Koa æœ¬èº«çš„æ„é€ å™¨ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå®ƒå¹¶æ²¡æœ‰è®¾ç½®ä»»ä½•çš„æœåŠ¡å™¨ç›¸å…³å†…å®¹ï¼Œé‚£ä¹ˆä¼šåœ¨å“ªé‡Œï¼Ÿå…¶å® Koa éƒ½æ˜¯è‡ªå·±å°è£…åˆ°ä¸€ä¸ª<code>listen</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * Shorthand for:
 *
 *    http.createServer(app.callback()).listen(...)
 *
 * @param {Mixed} ...
 * @return {Server}
 * @api public
 */</span>
<span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'listen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç›´æ¥é€šè¿‡http.createServeråˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨</span>
  <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ ¹æ®ä¼ å…¥çš„å‚æ•°åˆå§‹åŒ–httpæœåŠ¡å™¨</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯ï¼ŒKoa å·²ç»ä¸ºæ¯ä¸€ä¸ªå®ä¾‹éƒ½å¸¦äº†ä¸€ä¸ª<code>listen</code>æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªç›¸åº”çš„ http æœåŠ¡å™¨ã€‚é‚£ä¹ˆé‡ç‚¹æ¥äº†ï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœ<strong>ä½¿ç”¨<code>app.listen</code>åˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ Koa å½“å‰å®ä¾‹çš„<code>this.callback</code>æ–¹æ³•ï¼Œå¥½æ˜æ˜¾ï¼Œè¯¥æ–¹æ³•æ‰§è¡Œå®Œåè‚¯å®šè¿”å›ä¸€ä¸ªå›è°ƒï¼Œå°±æ˜¯ç”¨äºå¤„ç†è¯·æ±‚çš„</strong>ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±æ¥çœ‹çœ‹è¯¥æ–¹æ³•æ˜¯åšäº›ä»€ä¹ˆäº‹æƒ…çš„ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * Return a request handler callback
 * for node's native http server.
 *
 * @return {Function}
 * @api public
 */</span>
<span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é‡ç‚¹ï¼ï¼ï¼é€šè¿‡koa-composeç»„åˆæ‰€æœ‰ä¸­é—´ä»¶å‡½æ•°</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">listenerCount</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onerror<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å…¨å±€ç›‘å¬é”™è¯¯äº‹ä»¶</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// å°è£…å¥½çš„å¤„ç†è¯·æ±‚çš„å‡½æ•°</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> handleRequest<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>çœ‹åˆ°è¿™é‡Œï¼Œä¹Ÿè®¸ä½ ä¼šçœ‹çš„æœ‰ç‚¹æ¨¡ç³Šï¼Œcompose æ˜¯å•¥ï¼Ÿthis.createContext å’Œ this.handleRequest è¿™ä¸¤ä¸ªæ–¹æ³•åˆæ˜¯å¹²å˜›çš„ï¼Ÿå…ˆä¸è¦æ€¥ï¼Œç›®å‰æˆ‘ä»¬å°±å¯ä»¥çŸ¥é“çš„å°±æ˜¯ï¼Œ<strong>æœ€ç»ˆæ”¾è¿›<code>http.createServer</code>ä¸­çš„å›è°ƒå‡½æ•°å°±æ˜¯ä¸‹é¢è¿™ä¸ªï¼š</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// å°è£…å¥½çš„å¤„ç†è¯·æ±‚çš„å‡½æ•°</span>
  <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¥½äº†ï¼Œæ¥ä¸‹æ¥å°±åˆ°æˆ‘ä»¬çš„é‡å¤´æˆå•¦ã€‚å…ˆä»‹ç»ä¸€ä¸‹ compose è¿™ä¸ªæ–¹æ³•ï¼Œç©¶ç«Ÿä½•æ–¹ç¥åœ£ï¼ğŸ˜„</p> <h2 id="ä¸­é—´ä»¶å¤„ç†å‡½æ•°çš„ç»„åˆ"><a href="#ä¸­é—´ä»¶å¤„ç†å‡½æ•°çš„ç»„åˆ" class="header-anchor">#</a> ä¸­é—´ä»¶å¤„ç†å‡½æ•°çš„ç»„åˆ</h2> <p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘å…ˆç®€å•ä»‹ç»ä¸€ä¸‹è‘—åçš„ Koa ä¸­é—´ä»¶çš„æ´‹è‘±æ¨¡å‹å›¾ï¼ˆæ¥è‡ªç½‘å›¾ï¼Œå¦‚ä¾µæƒå¯åˆ é™¤ï¼‰ã€‚
<img src="https://user-images.githubusercontent.com/15081323/78218999-4e6e1900-74f1-11ea-923f-246457adf2d1.png" alt="Koaä¸­é—´ä»¶çš„æ´‹è‘±æ¨¡å‹å›¾"></p> <p><strong>ç±»ä¼¼äº JavaScript çš„ DOM äº‹ä»¶æµå¤„ç†æ–¹å¼ï¼Œå…ˆä»å¤–å±‚èµ°åˆ°æœ€å†…å±‚ï¼Œæ¥ç€å†ä»å†…å±‚èµ°åˆ°å¤–å±‚</strong>ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æŒ‰ä»»åŠ¡ä¼˜å…ˆçº§æ¥è¿›è¡Œåˆ’åˆ†å¤„ç†ï¼Œå…ˆå°†ä»»åŠ¡ä¼˜å…ˆçº§æœ€é«˜çš„è¿›è¡Œå¤„ç†ï¼Œç„¶åå†å¤„ç†ä»»åŠ¡ä¼˜å…ˆçº§ä½ã€‚</p> <p>ä¹Ÿè®¸ä½ ä¼šå¥½å¥‡æ˜¯å¦‚ä½•å®ç°ä»å¤–åˆ°å†…ï¼Œç„¶ååˆä»å†…åˆ°å¤–çš„ï¼Œåœ¨ Koa 2.0 ä¸­è¿™ä¸€åˆ‡éƒ½æ˜¯é€šè¿‡ <strong>async/await</strong> å®ç°çš„ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸‹é¢ç®€å•çš„ğŸŒ°ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">33</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>

<span class="token comment">// è¾“å‡ºç»“æœä¸º</span>
<span class="token comment">// 1</span>
<span class="token comment">// 2</span>
<span class="token comment">// 3</span>
<span class="token comment">// 33</span>
<span class="token comment">// 22</span>
<span class="token comment">// 11</span>
</code></pre></div><p>æ—¢ç„¶æ˜¯ä½¿ç”¨ async/await å®ç°ï¼Œé‚£æ€»å¾—éœ€è¦æŠŠä»–ä»¬è¿™äº›ä¸­é—´ä»¶å›è°ƒå‡½æ•°éƒ½æ•´åˆèµ·æ¥å§ï¼Ÿæ²¡é”™ï¼Œè¿™å°±å¾—ç›Šäº<code>koa-compose</code>çš„å¤„ç†ï¼Œå…¶å®<code>koa-compose</code>åœ¨æºç ä¸Šçš„å®ç°å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ª<code>compose</code>æ–¹æ³•ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * Compose `middleware` returning
 * a fully valid middleware comprised
 * of all those which are passed.
 *
 * @param {Array} middleware
 * @return {Function}
 * @api public
 */</span>

<span class="token keyword">function</span> <span class="token function">compose</span> <span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>middleware<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Middleware stack must be an array!'</span><span class="token punctuation">)</span> <span class="token comment">// åˆ¤æ–­ä¼ å…¥çš„ä¸­é—´ä»¶æ˜¯å¦ä¸ºä¸€ä¸ªæ•°ç»„</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> fn <span class="token keyword">of</span> middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// éå†æ•°ç»„ï¼Œé€ä¸ªå…ƒç´ åˆ¤æ–­æ˜¯å¦ä¸ºå‡½æ•°</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Middleware must be composed of functions!'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @param {Object} context
   * @return {Promise}
   * @api public
   */</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// last called middleware #</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// å¼€å§‹æ‰§è¡Œæµç¨‹</span>
    <span class="token keyword">function</span> <span class="token function">dispatch</span> <span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> index<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'next() called multiple times'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      index <span class="token operator">=</span> i
      <span class="token keyword">let</span> fn <span class="token operator">=</span> middleware<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token comment">// æ¯æ¬¡æ‰§è¡Œéƒ½æ‹¿å½“å‰éå†åˆ°çš„ä¸­é—´ä»¶å‡½æ•°å‡ºæ¥</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> middleware<span class="token punctuation">.</span>length<span class="token punctuation">)</span> fn <span class="token operator">=</span> next <span class="token comment">// å½“éå†çš„ä½ç½®æ˜¯æœ€åä¸€ä¸ªæ—¶ï¼Œé‚£ä¹ˆä¸­é—´ä»¶å‡½æ•°å°±æ˜¯ä¸ºç©º</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// å½“ä¸­é—´ä»¶å‡½æ•°ä¸ºç©ºæ—¶ï¼Œç›´æ¥æ‰§è¡ŒPromise.resolveæ–¹æ³•</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token function">dispatch</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ¯æ¬¡éå†éƒ½ä¼šè¿”å›ä¸€ä¸ªPromiseï¼Œå¹¶ä¸”åœ¨è¿”å›ä¹‹å‰ä¼šæ‰§è¡Œå½“å‰éå†åˆ°çš„ä¸­é—´ä»¶å‡½æ•°</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°è•´å«å¾ˆå¤šçŸ¥è¯†ç‚¹åœ¨è¿™é‡Œé¢ã€‚é¦–å…ˆå°±æ˜¯è¿ç”¨äº†é—­åŒ…å­˜å‚¨äº†å½“å‰éå†çš„ä½ç½® indexï¼Œå› æ­¤åœ¨è°ƒç”¨<code>compose</code>æ–¹æ³•æ—¶ï¼Œå®è´¨è¿”å›çš„å°±æ˜¯<code>Promise.resolve(fn(context, dispatch.bind(null, i + 1)))</code>ï¼Œåœ¨è¿”å›çš„è¿‡ç¨‹ä¸­ä¹Ÿä¼šç«‹é©¬æ‰§è¡Œäº†å½“å‰éå†åˆ°çš„ä¸­é—´ä»¶å‡½æ•°ã€‚</p> <p>åœ¨è¿™é‡Œï¼Œä¹Ÿè®¸ä½ åœ¨çœ‹ä»£ç çš„æ—¶å€™ä¼šæœ‰ç–‘æƒ‘ï¼Œ<strong>Promise.resolve é‡Œé¢ç¬¬äºŒä¸ªå‚æ•°æ˜¯<code>dispatch.bind(null, i + 1)</code>ï¼Œè¿™æ˜æ˜¾åªæ˜¯è¿”å›äº†ä¸€ä¸ª<code>this</code>æŒ‡å‘<code>windows</code>çš„å‡½æ•°é¸­ï¼Œé‚£ä»€ä¹ˆæ—¶å€™å¼€å§‹æ‰§è¡Œï¼Ÿ</strong></p> <p>è¿™ä¸ªé—®é¢˜å½“æ—¶æˆ‘ä¹Ÿæ˜¯æ„Ÿåˆ°è¿·æƒ‘åœ°æ–¹ï¼Œåé¢å†ç»“åˆä¸Šé¢<code>async/await</code>ä»£ç ä¸€çœ‹ï¼Œç»“æœå°±å¾ˆæ˜æ˜¾ï¼Œç­”æ¡ˆå°±åœ¨<code>await next()</code>é‡Œé¢ï¼Œå…¶ä¸­<code>next</code>å‡½æ•°å°±æ˜¯<code>dispatch.bind(null, i + 1)</code>ï¼Œè¿™æ ·ä¸€æ¥åˆä¼šé‡å¤<code>dispatch</code>è¿‡ç¨‹ã€‚</p> <p>æ€»ç»“ä¸€ä¸‹ï¼Œ<strong><code>compose</code>å‡½æ•°æ‰§è¡Œçš„æ˜¯ä¸€ä¸ª<code>dispatch</code>è¿‡ç¨‹ï¼Œæ‰€è°“<code>dispatch</code>è¿‡ç¨‹ï¼Œå°±æ˜¯å°†å½“å‰çš„ä¸­é—´ä»¶å‡½æ•°æ‰§è¡Œï¼Œå…¶ä¸­<code>context</code>ä¸Šä¸‹æ–‡ä½œä¸ºä¸­é—´ä»¶å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ<code>dispatch.bind(null, i + 1)</code>è¿”å›çš„ç»‘å®šå‡½æ•°ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ï¼Œå½“æ‰§è¡Œ<code>await next()</code>æ—¶ä¼šé‡æ–°æ‰§è¡Œ<code>dispatch</code>è¿‡ç¨‹ï¼ˆå³é€’å½’è¿‡ç¨‹ï¼‰ï¼Œæœ€ç»ˆä½¿ç”¨<code>Promise.resolve</code>åŒ…è½¬å¥½è¿”å›</strong>ã€‚</p> <h2 id="ä¸Šä¸‹æ–‡-context-çš„å°è£…"><a href="#ä¸Šä¸‹æ–‡-context-çš„å°è£…" class="header-anchor">#</a> ä¸Šä¸‹æ–‡ context çš„å°è£…</h2> <p>æˆ‘ä»¬æ¥ç€å›åˆ°ä¸Šè¿°è¿™æ®µ callback çš„ä»£ç ã€‚å¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * Return a request handler callback
 * for node's native http server.
 *
 * @return {Function}
 * @api public
 */</span>
<span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é‡ç‚¹ï¼ï¼ï¼é€šè¿‡koa-composeç»„åˆæ‰€æœ‰ä¸­é—´ä»¶å‡½æ•°</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">listenerCount</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onerror<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å…¨å±€ç›‘å¬é”™è¯¯äº‹ä»¶</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// å°è£…å¥½çš„å¤„ç†è¯·æ±‚çš„å‡½æ•°</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> handleRequest<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸Šé¢æˆ‘å·²ç»è®²äº† compose çš„æºç å®ç°ï¼Œé‚£ä¹ˆä¸‹é¢å°±è¦æ¥åˆ°<code>handleReques</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¹Ÿæ˜¯æœ€ç»ˆä½œä¸º<code>http.createServer()</code>çš„å›è°ƒå‡½æ•°ã€‚</p> <p>å…ˆæ¥çœ‹ä¸‹<code>createContext</code>å‡½æ•°ï¼Œå¥½æ˜æ˜¾ï¼Œçœ‹å­—é¢æ„æ€çš„è¯ï¼Œè¯¥å‡½æ•°å°±æ˜¯åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡ context çš„æ„æ€ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * Initialize a new context.
 *
 * @api private
 */</span>

<span class="token function">createContext</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°†å°è£…å¥½çš„contextä½œä¸ºåŸå‹å¯¹è±¡</span>
  <span class="token keyword">const</span> request <span class="token operator">=</span> context<span class="token punctuation">.</span>request <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°†å°è£…å¥½çš„requestå¯¹è±¡ä½œä¸ºcontext.requestå¯¹è±¡çš„åŸå‹å¯¹è±¡</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> context<span class="token punctuation">.</span>response <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°†å°è£…å¥½çš„responseå¯¹è±¡ä½œä¸ºcontext.responseå¯¹è±¡çš„åŸå‹å¯¹è±¡</span>
  context<span class="token punctuation">.</span>app <span class="token operator">=</span> request<span class="token punctuation">.</span>app <span class="token operator">=</span> response<span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// å°†å½“å‰koaå®ä¾‹ä¿å­˜åˆ°context.appä¸­</span>
  context<span class="token punctuation">.</span>req <span class="token operator">=</span> request<span class="token punctuation">.</span>req <span class="token operator">=</span> response<span class="token punctuation">.</span>req <span class="token operator">=</span> req<span class="token punctuation">;</span> <span class="token comment">// å°†NodeåŸç”Ÿçš„reqå¯¹è±¡ä¿å­˜åˆ°context.reqä¸­</span>
  context<span class="token punctuation">.</span>res <span class="token operator">=</span> request<span class="token punctuation">.</span>res <span class="token operator">=</span> response<span class="token punctuation">.</span>res <span class="token operator">=</span> res<span class="token punctuation">;</span> <span class="token comment">// å°†NodeåŸç”Ÿçš„reså¯¹è±¡ä¿å­˜åˆ°context.resä¸­</span>
  request<span class="token punctuation">.</span>ctx <span class="token operator">=</span> response<span class="token punctuation">.</span>ctx <span class="token operator">=</span> context<span class="token punctuation">;</span> <span class="token comment">// å°†å½“å‰å°è£…å¥½çš„contextå¯¹è±¡ä¿å­˜åˆ°request.ctxå’Œresponse.ctxä¸Š</span>
  request<span class="token punctuation">.</span>response <span class="token operator">=</span> response<span class="token punctuation">;</span> <span class="token comment">// å°†å°è£…å¥½çš„responseä¿å­˜åˆ°request.responseä¸­</span>
  response<span class="token punctuation">.</span>request <span class="token operator">=</span> request<span class="token punctuation">;</span> <span class="token comment">// å°†å°è£…å¥½çš„requestä¿å­˜åˆ°response.requestä¸­</span>
  context<span class="token punctuation">.</span>originalUrl <span class="token operator">=</span> request<span class="token punctuation">.</span>originalUrl <span class="token operator">=</span> req<span class="token punctuation">.</span>url<span class="token punctuation">;</span> <span class="token comment">// å°†å½“å‰è¯·æ±‚çš„urlä¿å­˜åˆ°reqeust.originalUrlå’Œcontext.originalUrlä¸­</span>
  context<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åŸæœ‰å°è£…å¥½çš„<code>context</code>æƒ…å†µä¸‹ï¼Œå°† Koa å°è£…å¥½çš„<code>this.request</code>å’Œ<code>this.response</code>å¯¹è±¡ä¿å­˜ä¸€ä»½åˆ°<code>context</code>ä¸Šä¸‹æ–‡ä¸‹ã€‚</p> <p>å½“ç„¶éœ€è¦é¢å¤–æ³¨æ„çš„æ˜¯ï¼Œ<strong><code>this.request</code>å’Œ<code>this.response</code>éƒ½æ˜¯ Koa å¯¹è¯·æ±‚å’Œå“åº”çš„å°è£…ï¼Œè€Œ<code>req</code>å’Œ<code>res</code>åˆ™æ˜¯ Node åŸç”Ÿçš„ request å¯¹è±¡å’Œ response å¯¹è±¡</strong>ã€‚</p> <p>æ€»ç»“ä¸€ä¸‹ï¼Œ<strong>æ¯å½“è¯·æ±‚è¿›å…¥ HTTP æœåŠ¡å™¨æ—¶ï¼Œéƒ½ä¼šåœ¨åŸå°è£…å¥½çš„<code>context</code>å¯¹è±¡ä¸‹æ·»åŠ <code>reuquest</code>å’Œ<code>response</code>ï¼Œç„¶åè¿”å›ä¸€ä¸ª<code>context</code>å¯¹è±¡ï¼ˆå³æ²¡æ¥å—ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œéƒ½ä¼šæ–°åˆ›å»ºä¸€ä¸ª<code>context</code>å¯¹è±¡ï¼‰</strong>ã€‚</p> <h2 id="å¤„ç†æœåŠ¡å™¨æ‰€æ¥æ”¶çš„è¯·æ±‚"><a href="#å¤„ç†æœåŠ¡å™¨æ‰€æ¥æ”¶çš„è¯·æ±‚" class="header-anchor">#</a> å¤„ç†æœåŠ¡å™¨æ‰€æ¥æ”¶çš„è¯·æ±‚</h2> <p>åˆ°äº†è¿™é‡Œï¼Œç›¸ä¿¡ä½ åº”è¯¥çŸ¥é“è¦è®²çš„å°±æ˜¯<code>handleRequest</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°±æ˜¯æœ€ç»ˆå¤„ç†è¯·æ±‚å’Œå“åº”çš„ã€‚å…ˆæ¥çœ‹æºç å§ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * Handle request in callback.
 *
 * @api private
 */</span>

<span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> fnMiddleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> ctx<span class="token punctuation">.</span>res<span class="token punctuation">;</span> <span class="token comment">// å…ˆç¼“å­˜Nodeä¸ŠåŸç”Ÿçš„responseå¯¹è±¡</span>
  res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span> <span class="token comment">// é»˜è®¤çŠ¶æ€ä¸º404</span>
  <span class="token keyword">const</span> <span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token function">onerror</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å®šä¹‰é”™è¯¯å¤„ç†</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleResponse</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">respond</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å®šä¹‰æœ€ç»ˆè¿”å›ç»™å®¢æˆ·ç«¯çš„å†…å®¹å¤„ç†</span>
  <span class="token function">onFinished</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> onerror<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// HTTP è¯·æ±‚å…³é—­ã€å®Œæˆæˆ–é”™è¯¯æ—¶æ‰§è¡Œç›¸åº”å›è°ƒ</span>
  <span class="token keyword">return</span> <span class="token function">fnMiddleware</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>handleResponse<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>onerror<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æŒ‰éœ€æ‰§è¡Œç›¸åº”çš„ä¸­é—´ä»¶å‡½æ•°ï¼Œå¹¶åœ¨æœ€åå¤„ç†å¥½è¿”å›ç»™å®¢æˆ·ç«¯</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œæºç å¾ˆç®€å•ï¼Œå¯¹äºè¿”å›ç»™å®¢æˆ·ç«¯çš„å†…å®¹å¤„ç†éƒ½å°è£…åœ¨<code>response</code>æ–¹æ³•é‡Œé¢ï¼ˆè¿™é‡Œæš‚ä¸è®¨è®ºï¼Œå…¶å®å®ç°å°±æ˜¯æ ¹æ®æƒ…å†µåœ¨res.endæ–¹æ³•ä¸­è¿”å›ï¼‰ã€‚</p> <p>ç„¶è€Œï¼Œä½ ä¼šå‘ç°æœ‰ä¸€ä¸ªæ–¹æ³•<code>onFinished</code>å¾ˆå¥‡æ€ªï¼Œå®ƒç©¶ç«Ÿæ˜¯å¹²å˜›çš„ï¼Ÿ</p> <p>å…¶å®å®ƒå°±æ˜¯<strong>å½“ HTTP åœ¨è¯·æ±‚å…³é—­ã€å®Œæˆæˆ–é”™è¯¯çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°å­˜åœ¨ç›‘å¬åˆ°çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°±ä¼šç«‹é©¬æ‰§è¡Œï¼Œè¿™æ ·ä¸€æ¥å°±ä¸éœ€è¦åœ¨æ¯ä¸€ä¸ªè¿‡ç¨‹ä¸­éƒ½ç¼–å†™ä¸€é</strong>ã€‚å¥½æ¯”å¦‚ä¸Šè¿°çš„ï¼Œä½¿ç”¨ onerror äº‹ä»¶ä½œä¸ºå¤„ç†å›è°ƒï¼Œæ˜æ˜¾çš„ï¼Œå½“åœ¨è¯·æ±‚å…³é—­ã€å®Œæˆæˆ–é”™è¯¯çš„è¿‡ç¨‹ä¸­å‘ç°æœ‰é”™è¯¯å‘ç”Ÿæ—¶ï¼Œä¾¿ä¼šè°ƒç”¨ä¸€æ¬¡ onerror äº‹ä»¶ã€‚</p> <p>åˆ°äº†æœ€åï¼ŒæŒ‰åºæ‰§è¡Œç›¸åº”çš„ä¸­é—´ä»¶å‡½æ•°ï¼Œå¹¶å¤„ç†å¥½çš„ç»“æœä½œä¸º<code>respond</code>æ–¹æ³•çš„å‚æ•°ï¼Œå½“ç„¶æœ€åä¹Ÿæ˜¯ä¼šå°†å¤„ç†å¥½çš„ç»“æœè¿”å›åˆ°å®¢æˆ·ç«¯ä¸­ã€‚</p> <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h2> <p><strong>Koa æºç çš„æ ¸å¿ƒåœ¨äºä¸­é—´ä»¶çš„å¤„ç†ï¼Œå³æ´‹è‘±æ¨¡å‹ã€‚é€šè¿‡æ‰§è¡Œ<code>compose</code>æ–¹æ³•æ¥é€’å½’æ‰§è¡Œ<code>dispatch</code>æ–¹æ³•ï¼Œæ¯é€’å½’ä¸€æ¬¡å°±æ‰§è¡Œä¸€æ¬¡å½“å‰çš„ä¸­é—´ä»¶å¤„ç†ï¼Œæ‰§è¡Œå®Œåï¼Œä½¿ç”¨<code>Promise.resolve</code>åŒ…è£…ä¸€å±‚å¹¶å°†ç»“æœè¿”å›</strong>ã€‚</p> <p>å¦å¤–çš„è¯ï¼Œä¹Ÿå°‘ä¸äº†å¯¹<code>context</code>å¯¹è±¡ã€<code>request</code>å¯¹è±¡ã€<code>response</code>å¯¹è±¡çš„å°è£…ã€‚</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/nodejs/nodejs-learning-and-summary/Node-åŸºç¡€çŸ¥è¯†.html" class="prev">
        Nodejs çŸ¥è¯†ç‚¹æ€»ç»“
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.62b9dc26.js" defer></script><script src="/assets/js/2.1177bb59.js" defer></script><script src="/assets/js/80.dcf79b90.js" defer></script>
  </body>
</html>
